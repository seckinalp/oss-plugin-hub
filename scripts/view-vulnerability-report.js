#!/usr/bin/env node

/**
 * Vulnerability Report Viewer
 * Displays human-readable vulnerability analysis reports
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const OSV_SCANS_DIR = path.join(__dirname, '../data/osv-scans');

// Get file from command line args
const fileArg = process.argv[2];

if (!fileArg) {
  console.log('Usage: node view-vulnerability-report.js <analysis-file>');
  console.log('\nExample:');
  console.log('  node view-vulnerability-report.js 10up__ads-txt.analysis.json');
  console.log('  node view-vulnerability-report.js 10up__ads-txt  (without extension)');
  process.exit(1);
}

// Build file path
let filePath;
if (fileArg.endsWith('.analysis.json')) {
  filePath = path.join(OSV_SCANS_DIR, fileArg);
} else if (fileArg.endsWith('.osv.json')) {
  filePath = path.join(OSV_SCANS_DIR, fileArg.replace('.osv.json', '.analysis.json'));
} else {
  filePath = path.join(OSV_SCANS_DIR, fileArg + '.analysis.json');
}

if (!fs.existsSync(filePath)) {
  console.error(`Error: Analysis file not found: ${filePath}`);
  console.error('\nRun analyze-osv-vulnerabilities.js first to generate analysis files.');
  process.exit(1);
}

// Load and display report
const data = JSON.parse(fs.readFileSync(filePath, 'utf8'));

console.log('\n========================================');
console.log('   VULNERABILITY ANALYSIS REPORT');
console.log('========================================\n');

console.log(`Plugin: ${data.source.replace('.osv.json', '').replace(/__/g, '/')}`);
console.log(`Analyzed: ${new Date(data.analyzedAt).toLocaleString()}`);
console.log('');

console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
console.log('â”‚         SECURITY SUMMARY                â”‚');
console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
console.log('');

const s = data.summary;

// Overall status
let statusEmoji = 'âœ…';
let statusText = 'SECURE';
if (s.severityBreakdown.CRITICAL > 0) {
  statusEmoji = 'ðŸ”´';
  statusText = 'CRITICAL - URGENT ACTION REQUIRED';
} else if (s.severityBreakdown.HIGH > 0) {
  statusEmoji = 'ðŸŸ ';
  statusText = 'HIGH RISK - UPDATE RECOMMENDED';
} else if (s.severityBreakdown.MEDIUM > 0) {
  statusEmoji = 'ðŸŸ¡';
  statusText = 'MEDIUM RISK - MONITOR';
} else if (s.totalVulnerabilities > 0) {
  statusEmoji = 'ðŸŸ¢';
  statusText = 'LOW RISK';
}

console.log(`Status: ${statusEmoji} ${statusText}`);
console.log('');

console.log('Vulnerability Count:');
console.log(`  Total Vulnerabilities: ${s.totalVulnerabilities}`);
console.log(`  Unique CVEs/GHSAs: ${s.uniqueVulnerabilities}`);
console.log(`  Affected Packages: ${s.affectedPackages}`);
console.log(`  Stale Dependencies: ${s.stalePackages}`);
if (s.stalePackagesOldFix > 0) {
  console.log(`  âš ï¸  Old Fixes (>6 months): ${s.stalePackagesOldFix}`);
}
console.log('');

console.log('Severity Breakdown:');
console.log(`  ðŸ”´ CRITICAL: ${s.severityBreakdown.CRITICAL}`);
console.log(`  ðŸŸ  HIGH: ${s.severityBreakdown.HIGH}`);
console.log(`  ðŸŸ¡ MEDIUM: ${s.severityBreakdown.MEDIUM}`);
console.log(`  ðŸŸ¢ LOW: ${s.severityBreakdown.LOW}`);
console.log('');

console.log('Timeline:');
console.log(`  Recent (< 6 months): ${s.recentVulnerabilities}`);
console.log(`  Older issues: ${s.totalVulnerabilities - s.recentVulnerabilities}`);
console.log('');

console.log('Remediation:');
console.log(`  Fixes Available: ${s.hasFixAvailable}`);
console.log(`  No Fix Yet: ${s.totalVulnerabilities - s.hasFixAvailable}`);
console.log('');

// Recommendations
if (data.recommendations.length > 0) {
  console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
  console.log('â”‚         RECOMMENDATIONS                 â”‚');
  console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  console.log('');
  
  data.recommendations.forEach(rec => {
    const icon = {
      URGENT: 'ðŸš¨',
      HIGH: 'âš ï¸',
      MEDIUM: 'ðŸ“‹',
      INFO: 'âœ…',
    }[rec.priority] || 'ðŸ“Œ';
    
    console.log(`${icon} [${rec.priority}] ${rec.message}`);
  });
  console.log('');
}

// Stale dependencies
if (data.staleDependencies.length > 0) {
  console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
  console.log('â”‚      STALE DEPENDENCIES (FIX AVAILABLE) â”‚');
  console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  console.log('');
  
  data.staleDependencies.forEach((dep, i) => {
    const urgencyIcon = dep.isOldFix ? 'ðŸš¨' : 'ðŸ“¦';
    const timeInfo = dep.monthsSinceFix > 0 
      ? `Fix available for ${dep.monthsSinceFix} months` 
      : `Fix available for ${dep.daysSinceFix} days`;
    
    console.log(`${i + 1}. ${urgencyIcon} ${dep.package}`);
    console.log(`   Current: ${dep.currentVersion}`);
    console.log(`   Fixed in: ${dep.fixedIn}`);
    console.log(`   Severity: ${dep.severity}`);
    console.log(`   ${timeInfo}`);
    if (dep.isOldFix) {
      console.log(`   âš ï¸  URGENT: Fix has been available for over 6 months!`);
    }
    console.log(`   Vulnerabilities: ${dep.vulnerabilities.join(', ')}`);
    console.log(`   ðŸ“ ${dep.recommendation}`);
    console.log('');
  });
}

// Detailed vulnerabilities
if (data.vulnerabilities.length > 0) {
  console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
  console.log('â”‚      DETAILED VULNERABILITIES           â”‚');
  console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  console.log('');
  
  data.vulnerabilities.forEach((vuln, i) => {
    const severityIcon = {
      CRITICAL: 'ðŸ”´',
      HIGH: 'ðŸŸ ',
      MEDIUM: 'ðŸŸ¡',
      LOW: 'ðŸŸ¢',
    }[vuln.severity] || 'âšª';
    
    console.log(`${i + 1}. ${severityIcon} ${vuln.id} [${vuln.severity}]`);
    console.log(`   Score: ${vuln.severityScore.toFixed(1)}/10.0`);
    
    if (vuln.aliases.length > 0) {
      console.log(`   CVE: ${vuln.aliases.join(', ')}`);
    }
    
    console.log(`   Package: ${vuln.affected.package}@${vuln.affected.version}`);
    console.log(`   Summary: ${vuln.summary}`);
    
    if (vuln.cwes.length > 0) {
      console.log(`   Type: ${vuln.cwes.map(c => `${c.id} (${c.name})`).join(', ')}`);
    }
    
    console.log(`   Age: ${vuln.age.age} (published ${vuln.age.publishedDate})`);
    
    if (vuln.fix.isStale) {
      console.log(`   âœ… Fix: ${vuln.fix.recommendation}`);
    } else {
      console.log(`   âš ï¸  Fix: ${vuln.fix.recommendation}`);
    }
    
    // Show first 2 references
    if (vuln.references.length > 0) {
      console.log(`   References:`);
      vuln.references.slice(0, 2).forEach(ref => {
        console.log(`     â€¢ ${ref.url}`);
      });
      if (vuln.references.length > 2) {
        console.log(`     ... and ${vuln.references.length - 2} more`);
      }
    }
    
    console.log('');
  });
}

// Footer
console.log('========================================');
console.log('   END OF REPORT');
console.log('========================================\n');

// Quick action summary
if (s.totalVulnerabilities > 0) {
  console.log('QUICK ACTIONS:');
  
  if (s.severityBreakdown.CRITICAL > 0 || s.severityBreakdown.HIGH > 0) {
    console.log('  1. Review and update high-severity packages immediately');
  }
  
  if (data.staleDependencies.length > 0) {
    console.log(`  2. Update ${data.staleDependencies.length} stale dependencies with available fixes`);
  }
  
  if (s.totalVulnerabilities > s.hasFixAvailable) {
    console.log('  3. Monitor unfixed vulnerabilities for patches');
  }
  
  console.log('  4. Run security audit regularly');
  console.log('');
}














