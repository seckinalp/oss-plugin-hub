# Vulnerability Analysis Documentation

This document explains how to use the OSV vulnerability analysis tools to generate human-readable security reports from OSV scan results.

## Overview

The vulnerability analysis workflow consists of three main scripts:

1. **`scan-osv-from-sbom.js`** - Scans SBOM files using OSV scanner
2. **`analyze-osv-vulnerabilities.js`** - Analyzes OSV scan results and generates detailed reports
3. **`view-vulnerability-report.js`** - Displays human-readable vulnerability reports

## Quick Start

```bash
# 1. Scan SBOMs with OSV (if not done already)
npm run scan-osv

# 2. Analyze vulnerability data
npm run analyze-vulnerabilities

# 3. View a specific report
npm run view-vulnerability-report 10up__ads-txt
```

## Detailed Usage

### 1. Scan SBOMs with OSV

```bash
# Scan all SBOM files
node scripts/scan-osv-from-sbom.js

# Scan using Docker
node scripts/scan-osv-from-sbom.js --docker

# Scan with pattern filter
node scripts/scan-osv-from-sbom.js --pattern=facebook

# Force rescan existing
node scripts/scan-osv-from-sbom.js --force
```

### 2. Analyze Vulnerabilities

```bash
# Analyze all OSV scan results
npm run analyze-vulnerabilities

# Analyze with verbose output
node scripts/analyze-osv-vulnerabilities.js --verbose

# Analyze limited number of files
node scripts/analyze-osv-vulnerabilities.js --limit=10

# Force re-analyze existing
node scripts/analyze-osv-vulnerabilities.js --force
```

**Output Location:** `data/osv-scans/*.analysis.json`

### 3. View Vulnerability Report

```bash
# View report for a specific plugin
npm run view-vulnerability-report 10up__ads-txt

# Or with full filename
npm run view-vulnerability-report 10up__ads-txt.analysis.json
```

## Analysis Output Structure

Each `*.analysis.json` file contains:

```json
{
  "analyzedAt": "2025-12-17T20:37:44.123Z",
  "source": "10up__ads-txt.osv.json",
  "summary": {
    "totalVulnerabilities": 8,
    "uniqueVulnerabilities": 6,
    "affectedPackages": 7,
    "stalePackages": 8,
    "severityBreakdown": {
      "CRITICAL": 0,
      "HIGH": 0,
      "MEDIUM": 0,
      "LOW": 8
    },
    "recentVulnerabilities": 5,
    "hasFixAvailable": 8
  },
  "vulnerabilities": [
    {
      "id": "GHSA-v6h2-p8h4-qcjw",
      "severity": "LOW",
      "severityScore": 3.1,
      "cvssScores": [...],
      "aliases": ["CVE-2025-5889"],
      "summary": "brace-expansion Regular Expression Denial of Service vulnerability",
      "details": "...",
      "cwes": [
        {
          "id": "CWE-400",
          "name": "Uncontrolled Resource Consumption (DoS)"
        }
      ],
      "age": {
        "age": "Last Year",
        "isRecent": false,
        "publishedDate": "2025-06-09T21:30:51Z",
        "daysSincePublished": 190
      },
      "affected": {
        "package": "brace-expansion",
        "version": "1.1.11",
        "ecosystem": "npm"
      },
      "fix": {
        "isStale": true,
        "currentVersion": "1.1.11",
        "fixedIn": "2.0.2",
        "recommendation": "Upgrade to 2.0.2 or later"
      },
      "references": [...]
    }
  ],
  "staleDependencies": [
    {
      "package": "brace-expansion",
      "currentVersion": "1.1.11",
      "fixedIn": "2.0.2",
      "vulnerabilities": ["GHSA-v6h2-p8h4-qcjw"],
      "severity": "LOW",
      "recommendation": "Upgrade to 2.0.2 or later",
      "fixAvailableSince": "2025-06-11T20:54:10.000Z",
      "daysSinceFix": 188,
      "monthsSinceFix": 6,
      "isOldFix": true
    }
  ],
  "recommendations": [
    {
      "priority": "MEDIUM",
      "message": "5 vulnerabilities were recently discovered (< 6 months old)."
    }
  ]
}
```

## Key Features

### 1. Vulnerability Count & Severity
- **Total Vulnerabilities**: Count of all vulnerability instances
- **Unique Vulnerabilities**: Deduplicated by CVE/GHSA ID
- **Severity Breakdown**: CRITICAL, HIGH, MEDIUM, LOW distribution

### 2. Vulnerability Age Detection
- **Very Recent**: < 1 month old
- **Recent**: < 6 months old
- **Last Year**: < 1 year old
- **Older**: > 1 year old

### 3. Stale Dependency Detection
Identifies packages with:
- Current vulnerable version
- Available fixed version
- Specific upgrade recommendation
- **Time since fix available** (days & months)
- **Old fix detection** (fixes available for >6 months)
- Urgency indicators (ðŸš¨ for old fixes, ðŸ“¦ for recent fixes)

### 4. CWE Classification
Maps vulnerabilities to Common Weakness Enumeration types:
- **CWE-79**: Cross-Site Scripting (XSS)
- **CWE-89**: SQL Injection
- **CWE-78**: OS Command Injection
- **CWE-400**: Uncontrolled Resource Consumption (DoS)
- **CWE-1333**: ReDoS (Regular Expression Denial of Service)
- **CWE-1321**: Prototype Pollution
- And more...

### 5. Automated Recommendations
Priority-based recommendations:
- **URGENT**: Critical vulnerabilities found
- **HIGH**: High severity issues detected
- **MEDIUM**: Recent vulnerabilities or fixes available
- **INFO**: No issues found

## Report Example

```
========================================
   VULNERABILITY ANALYSIS REPORT
========================================

Plugin: 10up/ads-txt
Analyzed: 17.12.2025 21:37:44

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SECURITY SUMMARY                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Status: ðŸŸ¢ LOW RISK

Vulnerability Count:
  Total Vulnerabilities: 8
  Unique CVEs/GHSAs: 6
  Affected Packages: 7
  Stale Dependencies: 8
  âš ï¸  Old Fixes (>6 months): 3

Severity Breakdown:
  ðŸ”´ CRITICAL: 0
  ðŸŸ  HIGH: 0
  ðŸŸ¡ MEDIUM: 0
  ðŸŸ¢ LOW: 8

Timeline:
  Recent (< 6 months): 5
  Older issues: 3

Remediation:
  Fixes Available: 8
  No Fix Yet: 0

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         RECOMMENDATIONS                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ðŸ“‹ [MEDIUM] 5 vulnerabilities were recently discovered (< 6 months old).
ðŸ“‹ [MEDIUM] 8 packages have known vulnerabilities with available fixes. Update recommended.

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      STALE DEPENDENCIES (FIX AVAILABLE) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ðŸš¨ brace-expansion
   Current: 1.1.11
   Fixed in: 2.0.2
   Severity: LOW
   Fix available for 6 months
   âš ï¸  URGENT: Fix has been available for over 6 months!
   Vulnerabilities: GHSA-v6h2-p8h4-qcjw
   ðŸ“ Upgrade to 2.0.2 or later

2. ðŸ“¦ glob
   Current: 10.4.5
   Fixed in: 11.1.0
   Severity: LOW
   Fix available for 28 days
   Vulnerabilities: GHSA-5j98-mcp5-4vw2
   ðŸ“ Upgrade to 11.1.0 or later

...
```

## Severity Scoring

Vulnerabilities are scored using CVSS (Common Vulnerability Scoring System):

| Score Range | Severity | Icon |
|-------------|----------|------|
| 9.0 - 10.0  | CRITICAL | ðŸ”´ |
| 7.0 - 8.9   | HIGH     | ðŸŸ  |
| 4.0 - 6.9   | MEDIUM   | ðŸŸ¡ |
| 0.1 - 3.9   | LOW      | ðŸŸ¢ |

## Use Cases

### 1. Security Audit
Run regular vulnerability scans to identify security issues:

```bash
npm run analyze-vulnerabilities --verbose
```

### 2. Pre-Release Checks
Check for critical vulnerabilities before releasing:

```bash
npm run view-vulnerability-report <plugin-name>
# Look for CRITICAL or HIGH severity issues
```

### 3. Dependency Update Planning
Identify which packages need updates:

```bash
npm run analyze-vulnerabilities
# Review staleDependencies section in *.analysis.json files
```

### 4. Compliance Reporting
Generate security reports for compliance:

```bash
# All analysis files are in data/osv-scans/*.analysis.json
# Use these for automated reporting
```

## Programmatic Access

You can also use the analysis data programmatically:

```javascript
import fs from 'fs';

// Load analysis
const analysis = JSON.parse(
  fs.readFileSync('data/osv-scans/10up__ads-txt.analysis.json', 'utf8')
);

// Check for critical issues
if (analysis.summary.severityBreakdown.CRITICAL > 0) {
  console.error('CRITICAL vulnerabilities found!');
  process.exit(1);
}

// Get stale dependencies
const stale = analysis.staleDependencies;
console.log(`Found ${stale.length} packages with available fixes`);

// Filter by severity
const highSeverity = analysis.vulnerabilities.filter(
  v => v.severity === 'HIGH' || v.severity === 'CRITICAL'
);
```

## Integration with CI/CD

Add to your CI/CD pipeline:

```yaml
# GitHub Actions example
- name: Scan vulnerabilities
  run: |
    npm run scan-osv
    npm run analyze-vulnerabilities
    
- name: Check for critical issues
  run: |
    node -e "
      const fs = require('fs');
      const files = fs.readdirSync('data/osv-scans')
        .filter(f => f.endsWith('.analysis.json'));
      
      let hasCritical = false;
      for (const file of files) {
        const data = JSON.parse(
          fs.readFileSync(\`data/osv-scans/\${file}\`, 'utf8')
        );
        if (data.summary.severityBreakdown.CRITICAL > 0) {
          console.error(\`CRITICAL issues in \${file}\`);
          hasCritical = true;
        }
      }
      
      if (hasCritical) process.exit(1);
    "
```

## Troubleshooting

### No analysis files generated

```bash
# Ensure OSV scans exist first
ls data/osv-scans/*.osv.json

# If missing, run OSV scan
npm run scan-osv
```

### Skipping existing files

```bash
# Use --force to re-analyze
npm run analyze-vulnerabilities -- --force
```

### Report not found

```bash
# Make sure to run analysis first
npm run analyze-vulnerabilities

# Then view report
npm run view-vulnerability-report <plugin-name>
```

## Related Scripts

- **`scan-osv-from-sbom.js`** - Initial OSV scanning
- **`fetch-sbom.js`** - Generate SBOMs from repositories
- **`analyze-repo-duplicates.js`** - Repository duplication analysis

## Further Reading

- [OSV.dev](https://osv.dev/) - Open Source Vulnerabilities Database
- [CVSS Calculator](https://www.first.org/cvss/calculator/3.1) - CVSS Score Calculator
- [CWE Database](https://cwe.mitre.org/) - Common Weakness Enumeration
- [SBOM Overview](https://www.cisa.gov/sbom) - Software Bill of Materials














